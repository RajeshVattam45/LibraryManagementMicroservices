name: CI/CD - Build, Migrate & Deploy APIs

on:
  push:
    branches: [ "master" ]

env:
  ACR_LOGIN_SERVER: libraryacr.azurecr.io
  IMAGE_TAG: latest

jobs:

  # ===========================
  # 1️⃣ Build + Migrations
  # ===========================
  build_and_migrate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install EF Core CLI
      run: dotnet tool install --global dotnet-ef

    - name: Add dotnet tools to PATH
      run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

    - name: Restore & Build
      run: |
        dotnet restore
        dotnet build --configuration Release

  # ===========================
  # 2️⃣ Build & Push Images
  # ===========================
  build_and_push_images:
    needs: build_and_migrate
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # ---------------------------
    # BookCatalog API
    # ---------------------------
    - name: Build & Push BookCatalog API
      run: |
        docker build \
          -t ${{ env.ACR_LOGIN_SERVER }}/bookcatalogservice:${{ env.IMAGE_TAG }} \
          -f BookCatalogService.API/Dockerfile .
        docker push ${{ env.ACR_LOGIN_SERVER }}/bookcatalogservice:${{ env.IMAGE_TAG }}

    # ---------------------------
    # Hostel API
    # ---------------------------
    - name: Build & Push Hostel API
      run: |
        docker build \
          -t ${{ env.ACR_LOGIN_SERVER }}/hostelservice:${{ env.IMAGE_TAG }} \
          -f HostelService.API/Dockerfile .
        docker push ${{ env.ACR_LOGIN_SERVER }}/hostelservice:${{ env.IMAGE_TAG }}
